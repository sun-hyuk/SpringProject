<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë¬¸ì˜í•˜ê¸°</title>
<link rel="stylesheet" th:href="@{/css/inquiry/inquiry.css}">
</head>
<body>
	<!-- 1) í—¤ë” -->
	<header class="header">
		<a href="javascript:history.back()" class="btn-back"> <img
			th:src="@{/images/vector-icon.png}" alt="ë’¤ë¡œê°€ê¸°" class="back-icon" />
		</a>
		<h1>ë¬¸ì˜í•˜ê¸°</h1>
	</header>

	<!-- 2) ìŠ¤í¬ë¡¤ ì˜ì—­ -->
	<div class="container">
		<!-- 2-1) íƒ­ -->
		<nav class="tabs">
			<div class="tab active" data-target="write">ë¬¸ì˜í•˜ê¸°</div>
			<div class="tab" data-target="history">ë¬¸ì˜ë‚´ì—­í™•ì¸</div>
		</nav>

		<!-- 2-2) ë¬¸ì˜ ì‘ì„± í¼ -->
		<div id="write" class="tab-content">
			<form class="inquiry-form" id="inquiryForm">
				<!-- ì¹´í…Œê³ ë¦¬ -->
				<div class="form-group inquiry-group">
					<select name="type" id="inquiryType" required>
						<option value="" disabled selected>ë¬¸ì˜ ì¹´í…Œê³ ë¦¬</option>
						<option value="ê³„ì •ë¬¸ì˜">ê³„ì • ë¬¸ì˜</option>
						<option value="ê°€ê³„ë¬¸ì˜">ê°€ê²Œ ë¬¸ì˜</option>
						<option value="ê¸°íƒ€">ê¸°íƒ€</option>
					</select>
				</div>

				<!-- ì œëª© -->
				<div class="form-group">
					<input type="text" name="title" id="inquiryTitle" maxlength="50"
						placeholder="ì œëª©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”. (50ì ì´ë‚´)" required />
				</div>

				<!-- ë‚´ìš© -->
				<div class="form-group">
					<textarea rows="6" name="content" id="inquiryContent"
						maxlength="500" placeholder="ë¬¸ì˜ ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”. (500ì ì´ë‚´)" required></textarea>
				</div>

				<!-- ì œì¶œ ë²„íŠ¼ -->
				<button type="submit" class="btn-submit">ë¬¸ì˜í•˜ê¸°</button>
			</form>
		</div>

		<!-- 2-3) ë¬¸ì˜ë‚´ì—­ í™•ì¸ -->
		<div id="history" class="tab-content" style="display: none">
			<!-- 1) ì‚¬ìš©ìëª… + ì¸ì‚¿ë§ -->
			<div class="history-header">
				<span
					th:text="${currentMemberNickname != null ? currentMemberNickname : 'ë¡œê·¸ì¸í•„ìš”'}">ì‚¬ìš©ì</span>
				ë‹˜ì˜ ë¬¸ì˜ë‚´ì—­
			</div>

			<!-- 2) 2ì°¨ íƒ­ (pill tabs) -->
			<nav class="history-tabs">
				<div class="pill active" data-filter="all">ì „ì²´</div>
				<div class="pill" data-filter="ëŒ€ê¸°ì¤‘">ì§„í–‰ ì¤‘</div>
				<div class="pill" data-filter="ì™„ë£Œ">ë‹µë³€ ì™„ë£Œ</div>
			</nav>

			<!-- 3) ì´ ì¹´ìš´íŠ¸ -->
			<div class="history-count">
				ì´ <span id="inquiryCount">0</span>ê±´ì˜ ë¬¸ì˜ê°€ ìˆì–´ìš” ğŸ˜Š
			</div>

			<!-- 4) ë¬¸ì˜ë‚´ì—­ ë¦¬ìŠ¤íŠ¸ -->
			<ul class="history-list" id="historyList">
			</ul>
		</div>
	</div>

	<!-- 3) í‘¸í„° -->
	<div th:replace="footer.html"></div>

	<!-- 4) JavaScript -->
	<script>
    // ì „ì—­ ë³€ìˆ˜
    let allInquiries = [];
    let currentFilter = 'all';

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¬¸ì˜ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    document.addEventListener('DOMContentLoaded', function() {
      loadInquiryList();
    });

    // ë©”ì¸ íƒ­ ì „í™˜
    document.querySelectorAll('.tabs .tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tabs .tab')
                .forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        document.querySelectorAll('.tab-content')
                .forEach(c => c.style.display = 'none');
        document.getElementById(tab.dataset.target).style.display = 'block';
        
        // ë¬¸ì˜ë‚´ì—­ íƒ­ìœ¼ë¡œ ì „í™˜ ì‹œ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        if (tab.dataset.target === 'history') {
          loadInquiryList();
        }
      });
    });

    // ë¬¸ì˜ ë“±ë¡ í¼ ì œì¶œ
    document.getElementById('inquiryForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const formData = {
        type: document.getElementById('inquiryType').value,
        title: document.getElementById('inquiryTitle').value.trim(),
        content: document.getElementById('inquiryContent').value.trim()
      };

      // ìœ íš¨ì„± ê²€ì‚¬
      if (!formData.type) {
        alert('ë¬¸ì˜ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
      if (!formData.title) {
        alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      if (!formData.content) {
        alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      // ì„œë²„ë¡œ ì „ì†¡
      fetch('/inquiry/create', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('ë¬¸ì˜ê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
          // í¼ ì´ˆê¸°í™”
          document.getElementById('inquiryForm').reset();
          // ë¬¸ì˜ë‚´ì—­ íƒ­ìœ¼ë¡œ ì´ë™
          document.querySelector('.tab[data-target="history"]').click();
          // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          loadInquiryList();
        } else {
          alert(data.message || 'ë¬¸ì˜ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('ë¬¸ì˜ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      });
    });

    // ë¬¸ì˜ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    function loadInquiryList() {
      fetch('/inquiry/list')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            allInquiries = data.inquiries;
            updateInquiryCount();
            renderInquiryList();
          } else {
            console.error('ë¬¸ì˜ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', data.message);
          }
        })
        .catch(error => {
          console.error('Error loading inquiry list:', error);
        });
    }

    // ë¬¸ì˜ ê°œìˆ˜ ì—…ë°ì´íŠ¸
    function updateInquiryCount() {
      const filteredInquiries = filterInquiries(currentFilter);
      document.getElementById('inquiryCount').textContent = filteredInquiries.length;
    }

    // ë¬¸ì˜ ëª©ë¡ í•„í„°ë§
    function filterInquiries(filter) {
      if (filter === 'all') {
        return allInquiries;
      }
      return allInquiries.filter(inquiry => inquiry.status === filter);
    }

    // ë¬¸ì˜ ëª©ë¡ ë Œë”ë§
    function renderInquiryList() {
      const historyList = document.getElementById('historyList');
      const filteredInquiries = filterInquiries(currentFilter);
      
      if (filteredInquiries.length === 0) {
        historyList.innerHTML = '<li style="text-align: center; padding: 20px; color: #666;">ë¬¸ì˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
        return;
      }

      historyList.innerHTML = filteredInquiries.map(inquiry => `
        <li class="history-item" data-status="${inquiry.status}" data-id="${inquiry.inquiryId}">
          <div class="item-header">
            <span class="status-badge ${inquiry.status === 'ëŒ€ê¸°ì¤‘' ? 'ongoing' : 'completed'}">
              ${inquiry.status === 'ëŒ€ê¸°ì¤‘' ? 'ì§„í–‰ì¤‘' : 'ë‹µë³€ ì™„ë£Œ'}
            </span>
            <span class="status-divider">|</span>
            <span class="inquiry-date">${inquiry.formattedCreatedAt}</span>
            <button type="button" class="close-btn" onclick="deleteInquiry(${inquiry.inquiryId})">&times;</button>
          </div>
          <p class="item-message" onclick="viewInquiryDetail(${inquiry.inquiryId})" style="cursor: pointer;">
            [${inquiry.typeDisplayName}] ${inquiry.title}
          </p>
        </li>
      `).join('');
    }

    // history íƒ­ (pill) ì´ë²¤íŠ¸
    document.querySelectorAll('.history-tabs .pill').forEach(pill => {
      pill.addEventListener('click', () => {
        document.querySelectorAll('.history-tabs .pill')
                .forEach(x => x.classList.remove('active'));
        pill.classList.add('active');
        currentFilter = pill.dataset.filter;
        updateInquiryCount();
        renderInquiryList();
      });
    });

    // ë¬¸ì˜ ì‚­ì œ
    function deleteInquiry(inquiryId) {
      if (!confirm('ì •ë§ë¡œ ì´ ë¬¸ì˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }

      fetch(`/inquiry/${inquiryId}`, {
        method: 'DELETE'
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('ë¬¸ì˜ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          loadInquiryList(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        } else {
          alert(data.message || 'ë¬¸ì˜ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('ë¬¸ì˜ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      });
    }

    // ë¬¸ì˜ ìƒì„¸ ë³´ê¸°
    function viewInquiryDetail(inquiryId) {
      window.location.href = `/inquiryDetail/${inquiryId}`;
    }
  </script>
</body>
</html>